---
title: "Project I"
author: "Soohee Jung"
date: "6/11/2021"
output:
  github_document:
    toc: TRUE
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# FUNCTIONS  
## Required Packages  
```{r}
library(httr)
library(jsonlite)
library(tidyverse)
library(ggplot2)
```

## Record-API Functions  

```{r message=FALSE}
# to mapping Franchise ids vs Full names vs Most recent team ID
frurl <- GET("https://records.nhl.com/site/api/franchise")
frtext <- content(frurl, "text", encoding = "UTF-8")
frlist <- fromJSON(frtext, flatten=TRUE)
frlist <- as.data.frame(frlist)
frtbl <- tibble(frlist$data.id, frlist$data.fullName, frlist$data.mostRecentTeamId)
# print to see what it looks like
head(frtbl)

# record API function
rcdURL <- function(list,recd,type,id){
  if (missing(recd) & missing(type) & missing(id)){
    rcdurl <- paste0("https://records.nhl.com/site/api/",list)
  }
  else if (missing(type) & missing(id)){
    rcdurl <- paste0("https://records.nhl.com/site/api/",list,"-",recd)
  }
  else {
    if (is.numeric(id)){
      rcdurl <- paste0("https://records.nhl.com/site/api/",list,"-",recd,"?cayenneExp=", type, "=", id)
    }
    else {
      if (type=="mostRecentTeamId"){
        id <- filter(filter(frtbl,frtbl[2]==id)[3])
        rcdurl <- paste0("https://records.nhl.com/site/api/",list,"-",recd,"?cayenneExp=", type, "=", id)
      }
      else {
        id <- filter(filter(frtbl,frtbl[2]==id)[1])
        rcdurl <- paste0("https://records.nhl.com/site/api/",list,"-",recd,"?cayenneExp=", type, "=", id)
      }
    }
  }
  return(rcdurl)
}

rcddt <- function(list,...){
  rcdNHL <- GET(rcdURL(list,...))
  rcdtext <- content(rcdNHL, "text",encoding = "UTF-8")
  rcdlist <- fromJSON(rcdtext, flatten=TRUE)
  rcdlist <- as.data.frame(rcdlist)
  return(rcdlist)
}
```

## Stat-API function  
```{r}
statURL <- function(list,id){
  if (missing(id)){
    staturl <- paste0("https://statsapi.web.nhl.com/api/v1/",list,"?expand=team.stats")
  }
  else{
    if (is.numeric(id)){
      staturl <- paste0("https://statsapi.web.nhl.com/api/v1/",list,"/",id,"?expand=team.stats")
    }
    else {
      id <- filter(filter(frtbl,frtbl[2]==id)[1])
      staturl <- paste0("https://statsapi.web.nhl.com/api/v1/",list,"/",id,"?expand=team.stats")
    }
  }
  return(staturl)
}

statdt <- function(list,...){
  statNHL <- GET(statURL(list,...))
  stattext <- content(statNHL, "text",encoding = "UTF-8")
  statlist <- fromJSON(stattext, flatten=TRUE)
  statlist <- as.data.frame(statlist)
  statlist <- unnest(unnest(statlist,cols = c(teams.teamStats)),cols = c(splits))
  return(statlist)
}
```

## Wrapper function to call the functions above  
```{r}
# choose record or stat and then put parameters what we want
wrapfnc <- function(fnc,list,...){
  if (fnc=="record"){
    return(rcddt(list,...))
  }
  else if (fnc=="stat"){
    return(statdt(list,...))
  }
  else cat("choose record or stat!!")
}
```

# Contingency Tables  
## Franchise Records  
```{r}
as.tbl(wrapfnc("record","franchise"))
```

## Franchise-team-totals Records  
```{r}
head(wrapfnc("record","franchise","team-totals"))
```

## franchise-season-records by franchiseId=ID  
```{r}
# I choose ID=10
head(wrapfnc("record","franchise","season-records","franchiseId",10))
# I choose Franchise full name="New Jersey Devils"
head(wrapfnc("record","franchise","season-records","franchiseId","New Jersey Devils"))
```

## franchise-goalie-records by franchiseId=ID  
```{r}
# I choose ID=20
head(wrapfnc("record","franchise","goalie-records","franchiseId",20))
# I choose Franchise full name="Philadelphia Flyers"
head(wrapfnc("record","franchise","goalie-records","franchiseId","Philadelphia Flyers"))
```

## franchise-skater-records by franchiseId=ID  
```{r}
# I choose ID=30
head(wrapfnc("record","franchise","skater-records","franchiseId",30))
# I choose Franchise full name="New York Rangers"
head(wrapfnc("record","franchise","skater-records","franchiseId","New York Rangers"))
```

## franchise-detail records by mostRecentTeamId=ID  
```{r}
# I choose ID=8
head(wrapfnc("record","franchise","detail","mostRecentTeamId",8))
# I choose Franchise full name="New York Islanders"
head(wrapfnc("record","franchise","detail","mostRecentTeamId","New York Islanders"))
```

## Team Stat modifier  
```{r}
# I choose all ID
head(wrapfnc("stat","teams"))
# I choose ID=1
head(wrapfnc("stat","teams",1))
# I choose Franchise full name="New Jersey Devils"
head(wrapfnc("record","franchise","detail","mostRecentTeamId","New Jersey Devils"))
```

# Getting basic ideas  
## Choose two franchises to compare with  
```{r}
# Look for interesting results from 'team-total' dataset. 
a <- wrapfnc("record","franchise","team-totals") %>% filter(data.gameTypeId==2 & data.gamesPlayed >2000) %>% 
  mutate(Winchance=data.wins/data.gamesPlayed) %>% select(data.franchiseId,data.gamesPlayed, data.wins, Winchance)
knitr::kable(a)
```

ID=1 had higher chance of win than ID=20 had. Let's find the factors which affect team winning!    

## Goals by skater position  
```{r}
skr <- wrapfnc("record","franchise","skater-records")
p <- ggplot(skr,aes(x=data.positionCode,y=data.goals,fill=data.positionCode))
p+geom_col()+scale_fill_brewer(palette = "Set2")+labs(x="Position",y="Goals",color="Position",title="< Goals by Position >")
```

Center position skater scored most goals and then right winger did. That makes sense!  

## Assists by skater position  
```{r}
a <- ggplot(skr,aes(x=data.positionCode, y=data.assists, fill=data.positionCode))
a+geom_col()+ scale_fill_brewer(palette = "PRGn")+labs(x="Position",y="Goals",color="Position",title="< Assists by Position >")
```

Center players assisted most and then Defenders did. I guessed wingers assisted most but the data tells different story. Interesting!!  

# FACTORS WHICH INFLUENCE TEAM WINNING  
## How skater assists affect winning?  
```{r}
# Filter datasets and create new variables
skid1 <- wrapfnc("record","franchise", "skater-records","franchiseId",1)
skid20 <- wrapfnc("record","franchise", "skater-records","franchiseId",20)

# Combine two datasets
cosk <- rbind(skid1,skid20)
cosk$data.franchiseId <- as.character(cosk$data.franchiseId)

# Summarise skaters assists records
avgassi <- c(ID.1=mean(skid1$data.assists),ID.20=mean(skid20$data.assists))
knitr::kable(avgassi,col.names = "Avg Assists")
```

We can see Franchise ID=1 had more average assists from the data.  

```{r}
# Create a graph to see the relationship between assists and goals
sk <- ggplot(cosk, aes(x=data.assists, y=data.goals))
sk+geom_jitter(aes(color=data.franchiseId))+labs(x="Assists",y="Goals",color="Franchise ID",title="< Assists and Goals >")
```

The franchise ID=1 had more average assists and higher winning chance than ID=20 did. This graph also tells us the relationship between assists and goals is linear. So, we can say **more assists leads higher chance of winning!**  

## How center position skater's penalty time affect goal?  
```{r}
# Summarise center position skater's penalty minutes records
center <- cosk %>% filter(data.positionCode== "C")
centerpt <- ggplot(center, aes(x=data.penaltyMinutes, y=data.goals))
centerpt + geom_line(aes(color=data.franchiseId)) + geom_smooth() +
  labs(x="Penalty Minutes", y="Goals",color="Franchise ID", title="< center skater Penalty minute and Goals >")
```

The skaters who are in a center position scored more goals as they had more penalty minutes. What?? Interesting!  

```{r}
ttotal <- wrapfnc("record","franchise","team-totals")
w <- ggplot(ttotal,aes(data.penaltyMinutes,data.wins))
g <- ggplot(ttotal,aes(data.penaltyMinutes,data.goalsFor))
g+geom_quantile()+labs(x="Penalty Minutes", y="Goals", title="< Penalty minutes and Goals >")
w+geom_quantile()+labs(x="Penalty Minutes", y="Wins", title="< Penalty minutes and Wins >")
```
  
What a surprising result!! I thought the penalty minutes would affects goals and winnings in negative ways, but the graphs tell us totally opposite story.  

## Is playing at Home really an advantage?  
```{r}
hwratio <- ttotal %>% filter(data.gameTypeId==2) %>% mutate(HomeWin.ratio=data.homeWins/data.wins) %>%
  select(data.teamName,data.homeWins, data.wins, HomeWin.ratio)
knitr::kable(hwratio)
r <- ggplot(hwratio,aes(x=HomeWin.ratio))
r+geom_histogram(bins=70,fill="purple")+labs(x="Home wins Ratio", title="< Home Game Winning Chance >")
```

All teams had over 50% of winning chance when they played at home. Playing at Home really an advantage!!  

## Stat  
```{r}
stat <- wrapfnc("stat","teams")
# PIck odd number rows
stat <- stat[seq(1,62,2),]

```
