---
title: "NHL.API.Vignette"
author: "Soohee Jung"
date: "6/11/2021"
output:
  github_document:
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document is a vignette to show how retrieve data from an [API](https://en.wikipedia.org/wiki/API). I will use the NHL API to pull data and then summaries and explore the data pulled.  
# Required Packages  
To use the functions for interacting with the NHL API, I used the following packages:  
```{r message=FALSE}
library(httr)
library(jsonlite) #needs for API interaction
library(tidyverse) #tons of useful features for data manipulating and visualization
library(xml2)
```

# API interaction Functions  
I defined the functions to interact with the [NHL Record API](https://gitlab.com/dword4/nhlapi/-/blob/master/records-api.md) and [NHL Stats API](https://gitlab.com/dword4/nhlapi/-/blob/master/stats-api.md).  
## Record-API Functions  

```{r message=FALSE}
# to mapping Franchise ids vs Full names vs Most recent team ID
fr_url <- GET("https://records.nhl.com/site/api/franchise")
fr_text <- content(fr_url, "text", encoding = "UTF-8")
fr_list <- fromJSON(fr_text, flatten=TRUE)
fr_list <- as.data.frame(fr_list)
# Select Franchise ID, Full names, Most recent team ID
fr_tbl <- tibble(fr_list$data.id, fr_list$data.fullName, fr_list$data.mostRecentTeamId)
# print to see what it looks like
head(fr_tbl)

# Creating Record API function
# Function to get Endpoint URL
rcd_url <- function(list,recd,type,id){
  if (missing(recd) & missing(type) & missing(id)){
    rcdurl <- paste0("https://records.nhl.com/site/api/",list)
  }
  else if (missing(type) & missing(id)){
    rcdurl <- paste0("https://records.nhl.com/site/api/",list,"-",recd)
  }
  else {
    if (is.numeric(id)){
      rcdurl <- paste0("https://records.nhl.com/site/api/",list,"-",recd,"?cayenneExp=", type, "=", id)
    }
    else {
      if (type=="mostRecentTeamId"){
        id <- filter(filter(fr_tbl,fr_tbl[2]==id)[3]) #convert Full name to Most recent team ID
        rcdurl <- paste0("https://records.nhl.com/site/api/",list,"-",recd,"?cayenneExp=", type, "=", id)
      }
      else {
        id <- filter(filter(fr_tbl,fr_tbl[2]==id)[1]) #Convert Full name to Franchise ID
        rcdurl <- paste0("https://records.nhl.com/site/api/",list,"-",recd,"?cayenneExp=", type, "=", id)
      }
    }
  }
  return(rcdurl)
}

# Function to get data from the URL
rcd_dt <- function(list,recd,...){
  if (missing(recd)){
    rcd_NHL <- GET(rcd_url(list))
    rcd_text <- content(rcd_NHL, "text",encoding = "UTF-8")
    rcd_list <- fromJSON(rcd_text, flatten=TRUE)
    rcdl_ist <- as.data.frame(rcd_list)
  }
  else {
    if (recd=="detail"){
      rcd_NHL <- GET(rcd_url(list,recd,...))
      rcd_text <- content(rcd_NHL, "text",encoding = "UTF-8")
      rcd_list <- fromJSON(rcd_text, flatten=TRUE)
      rcd_list <- as.data.frame(rcd_list)
      # unwrap HTML file nested in franchise-detail endpoint
      ca<-read_html(rcd_list$data.captainHistory)        
      rcd_list$data.captainHistory<- xml_text(ca)
      co<-read_html(rcd_list$data.coachingHistory)        
      rcd_list$data.coachingHistory<- xml_text(co)
      ge<-read_html(rcd_list$data.generalManagerHistory)        
      rcd_list$data.generalManagerHistory<- xml_text(ge)
      re<-read_html(rcd_list$data.retiredNumbersSummary)        
      rcd_list$data.retiredNumbersSummary<- xml_text(re)
      rcd_list <- gsub("[\r\n\t]"," ",rcd_list)
    }
    else {
      rcd_NHL <- GET(rcd_url(list,recd,...))
      rcd_text <- content(rcd_NHL, "text",encoding = "UTF-8")
      rcd_list <- fromJSON(rcd_text, flatten=TRUE)
      rcd_list <- as.data.frame(rcd_list)
    }
  }
  return(rcd_list)
}
```

## Stat-API function  
```{r}
# Function to get Endpoint URL
stat_URL <- function(list,id){
  if (missing(id)){
    staturl <- paste0("https://statsapi.web.nhl.com/api/v1/",list,"?expand=team.stats")
  }
  else{
    if (is.numeric(id)){
      staturl <- paste0("https://statsapi.web.nhl.com/api/v1/",list,"/",id,"?expand=team.stats")
    }
    else {
      id <- filter(filter(fr_tbl,fr_tbl[2]==id)[3]) #convert Full name to Most recent team ID
      staturl <- paste0("https://statsapi.web.nhl.com/api/v1/",list,"/",id,"?expand=team.stats")
    }
  }
  return(staturl)
}

# Function to get data from the URL
stat_dt <- function(list,...){
  stat_NHL <- GET(stat_URL(list,...))
  stat_text <- content(stat_NHL, "text",encoding = "UTF-8")
  stat_list <- fromJSON(stat_text, flatten=TRUE)
  stat_list <- as.data.frame(stat_list)
  # Unwrap nested lists in stat endpoint
  stat_list <- unnest(unnest(stat_list,cols = c(teams.teamStats)),cols = c(splits))
  return(stat_list)
}
```

## Wrapper function to call the functions above  
```{r}
# choose record or stat and then put parameters to get data
wrap_fnc <- function(fnc,list,...){
  if (fnc=="record"){
    return(rcd_dt(list,...))
  }
  else if (fnc=="stat"){
    return(stat_dt(list,...))
  }
  else cat("Unavailable arguments")
}
```

# CONTINGENCY TABLES  
## Franchise Records  
```{r}
str(wrap_fnc("record","franchise"))
head(wrap_fnc("record","franchise"))
```

## Franchise-team-totals Records  
```{r}
tbl_df(wrap_fnc("record","franchise","team-totals"))
```

## franchise-season-records by franchiseId=ID  
```{r}
# I choose ID=10
tbl_df(wrap_fnc("record","franchise","season-records","franchiseId",10))
# I choose Franchise full name="New York Rangers"
tbl_df(wrap_fnc("record","franchise","season-records","franchiseId","New York Rangers"))
```

## franchise-goalie-records by franchiseId=ID  
```{r}
# I choose ID=20
tbl_df(wrap_fnc("record","franchise","goalie-records","franchiseId",20))
# I choose Franchise full name="Vancouver Canucks"
tbl_df(wrap_fnc("record","franchise","goalie-records","franchiseId","Vancouver Canucks"))
```

## franchise-skater-records by franchiseId=ID  
```{r}
# I choose ID=30
tbl_df(wrap_fnc("record","franchise","skater-records","franchiseId",30))
# I choose Franchise full name="Ottawa Senators"
tbl_df(wrap_fnc("record","franchise","skater-records","franchiseId","Ottawa Senators"))
```

## franchise-detail records by mostRecentTeamId=ID  
```{r}
# I choose ID=8
tbl_df(wrap_fnc("record","franchise","detail","mostRecentTeamId",8))
# I choose Franchise full name="Montréal Canadiens"
tbl_df(wrap_fnc("record","franchise","detail","mostRecentTeamId","Montréal Canadiens"))
```

## Team Stat modifier  
```{r}
# I choose all ID
tbl_df(wrap_fnc("stat","teams"))
# I choose ID=1
tbl_df(wrap_fnc("stat","teams",1))
# I choose Franchise full name="New Jersey Devils"
tbl_df(wrap_fnc("stat","teams","New Jersey Devils"))
```

# GETTING BASIC IDEAS  
## Choose two franchises to compare with  
```{r}
# create Winning percentage column and choose 2 comparable franchise IDs
a <- wrap_fnc("record","franchise","team-totals") %>% 
  filter(data.gameTypeId==2 & data.gamesPlayed >2000) %>% 
  mutate(win_chance=data.wins/data.gamesPlayed) %>% 
  select(data.franchiseId,data.gamesPlayed, data.wins, win_chance) %>% arrange(win_chance)
knitr::kable(a, col.names=gsub("data.","",names(a)), align="cccc",  caption="Winning percentage by Franchise ID")
```

ID=1 had higher chance of win(51.2%) than ID=20 had(41.8%). Let's find the factors which affected these different results!    

## Goals by skater position  
```{r}
# Full-join skater and goalie records 
sk_go_join=full_join(wrap_fnc("record","franchise","goalie-records"),wrap_fnc("record","franchise","skater-records"))
# Filter joined data to choose skaters
skaters <- sk_go_join %>% filter(data.positionCode != "G")
most_goal <- skaters %>% group_by(data.positionCode) %>% summarise(Goals=mean(data.mostGoalsOneSeason))
knitr::kable(most_goal, col.names = c("Position","Avg Goals"))
# Create a box-plot
p <- ggplot(skaters,aes(x=data.positionCode,y=data.mostGoalsOneSeason,fill=data.positionCode))
p+geom_boxplot()+scale_fill_brewer(palette = "Set2")+labs(x="Position",y="Goals",fill="Position",title="< Most Goals by skater Position >")
```

Right wingers scored most goals and then Center skaters did. Ok, I guessed center skaters scored most but their numbers are close so not a big surprise. That makes sense!  

## Assists by skater position  
```{r}
# skater's average assists by position
most_assi <- skaters %>% group_by(data.positionCode) %>% summarise(assist=mean(data.mostAssistsOneSeason))
knitr::kable(most_assi, col.names = c("Position","Assists"))
# Create a bar-plot
b <- ggplot(most_assi,aes(x=data.positionCode, y=assist, fill=data.positionCode))
b+geom_col()+scale_fill_brewer(palette="PRGn")+labs(x="Position",y="Assists",fill="Position",title="< Average Assists by skater Position >")
```

Center players assisted most and then right wingers did. I guessed both wingers assisted most but the data tells different story. Interesting!!  

## Some Numerical summaries  
```{r}
# How many players by position
table(sk_go_join$data.positionCode)
# Average Rookie games played
rookie <- sk_go_join %>% group_by(data.positionCode) %>% 
  summarise(rookieGames=mean(data.rookieGamesPlayed, na.rm=TRUE))
knitr::kable(rookie, col.names = c("Position","Rookie Game"))
# 2 = regular Season, 3 = play offs
w<-wrap_fnc("record","franchise","team-totals")
table(w$data.gameTypeId)
```

# FACTORS WHICH INFLUENCED TEAM WINNING  
## Do skater assists affect winning?  
```{r}
# Filter datasets to choose 2 teams with ID=1 and ID=20
two_ID <- skaters %>% filter(data.franchiseId==1 | data.franchiseId==20)
two_ID$data.franchiseId <- as.character(two_ID$data.franchiseId)
# Summarise skaters assists records
avg_assi <- two_ID %>% group_by(data.franchiseId) %>% summarise(avgassi=mean(data.assists))
knitr::kable(avg_assi,col.names = c("Franchise ID","Avg Assists"))
```

The franchise ID=1 had more average assists and higher winning chance than ID=20 did.  

```{r}
# Create a scatter-plot to see the relationship between assists and goals
ag <- ggplot(two_ID, aes(x=data.assists, y=data.goals))
ag + geom_jitter(aes(color=data.franchiseId)) +
  labs(x="Assists",y="Goals",color="Franchise ID",title="< Assists vs Goals >")
```

This graph also tells us the relationship between assists and goals is linear. So, we can say **more assists brought more goals and higher chance of winning!**  

## How center position skater's penalty time affect goal?  
```{r}
# Summarise center position skater's penalty minutes records
center <- two_ID %>% filter(data.positionCode== "C")
center_pt <- ggplot(center, aes(x=data.penaltyMinutes, y=data.goals))
center_pt + geom_line(aes(color=data.franchiseId)) + geom_smooth() +
  labs(x="Penalty Minutes", y="Goals",color="Franchise ID", title="< center skater Penalty minute and Goals >")
```

The center position skaters scored more goals as they had more penalty minutes. What?? Interesting!  

```{r message=FALSE, warning=FALSE}
# Penalty minutes vs Goals(Wins)
t_total <- wrap_fnc("record","franchise","team-totals")
w <- ggplot(t_total,aes(data.penaltyMinutes,data.wins))
g <- ggplot(t_total,aes(data.penaltyMinutes,data.goalsFor))
g+geom_quantile()+labs(x="Penalty Minutes", y="Goals", title="< Penalty minutes and Goals >")
w+geom_quantile()+labs(x="Penalty Minutes", y="Wins", title="< Penalty minutes and Wins >")
```
  
What a surprising result!! I thought the penalty minutes would affects goals and winnings in negative ways, but the graphs tell us totally opposite story.  

## Is playing at Home really an advantage?  
```{r}
# Create Home game winning ratio by homewins/wins
hw_ratio <- t_total %>% filter(data.gameTypeId==2) %>% mutate(HomeWin.ratio=data.homeWins/data.wins) %>%
  select(data.teamName,data.homeWins, data.wins, HomeWin.ratio)
# Look at the output numbers in a table
knitr::kable(hw_ratio)
# Look at the distribution of Home winning ratio
r <- ggplot(hw_ratio,aes(x=HomeWin.ratio))
r+geom_histogram(bins=70,fill="purple")+labs(x="Home wins Ratio", title="< Home Game Winning Chance >")
```

All teams had over 50% of winning chance when they played at home. Playing at Home really an advantage!!  

According to all above **More assists**, **More penalty minutes** and **Home game** helped teams win the games.

